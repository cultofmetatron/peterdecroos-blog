
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>console.blog( this.thought )</title>
	<meta name="author" content="Peter de Croos">

	
	<meta name="description" content="The web is abuzz right now with ecmascript 6 on the horizon. If you get node 0.11,
you can use it server side already. Once of the big features I&# &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="console.blog( this.thought )" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">console.blog( this.thought )</a></h1>
<nav id="main-nav"><ul class="main">
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:blog.peterdecroos.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		<a class="github" href="https://github.com/cultofmetatron" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:blog.peterdecroos.com">
	</form>
</nav>

</header>
	
	<div id="content" class="inner">


    <article class="post">
	<h1 class="title"><a href="/blog/2014/02/08/functional-programming-with-ecmascript6-generators/">Functional Programming With Ecmascript6 Generators</a></h1>
	<div class="entry-content">
		<p>The web is abuzz right now with ecmascript 6 on the horizon. If you get node 0.11,
you can use it server side already. Once of the big features I&#8217;m excited about
are generators.</p>

<p>I&#8217;ve <a href="http://blog.peterdecroos.com/blog/2014/01/22/javascript-generators-first-impressions/">blogged about them previously</a>
Alas, I&#8217;ve only found nothing out there on the web that covers anything beyond basic
instatiation and invocation. With just that to go on, it was hard for me to initially see
the hype. A few days ago, I had an appifany.</p>

<p>Generators are first class objects. Like functions, they can be composed from smaller parts. Therefore,
much of we know about functions can be applied to generators!</p>

<p>On that note, I will lay the ground work for understanding how to really USE generators.</p>

<h3>It all starts with a bind</h3>

<p>If you&#8217;ve worked with javascript for any of length of time, You should be familiar with bind.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">args2</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A function has 2 diffrent modes, literal and called.</p>

<ul>
<li>Literal: a function itself, its not being run.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">something</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;do something&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Called: running the function which gives us its return value along with side effects.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">something</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bind is implimented by taking a literal function and calling it within another
literal function passing along the context and possible arguments using .apply().</p>

<p>A Generator has 3 states,
  1. Literal: A literal Generator function</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Gen</span> <span class="o">=</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">asyncTask</span><span class="p">();</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Instantiated: a runnable instance is created by calling the Generator function</li>
</ol>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">Gen</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Run: You can then iterate through the generator by calling next()</li>
</ol>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unlike a function, We are going to compose generators to be run inside of a co() function.
Co will run a generator until it comes accross a yield. Whatever is on
right side of the yield will be passed into co. the generator will be frozen until the
value can be resolved. This includes thunks, promises and even other generators!</p>

<p>A generator equivilent for a bind looks like this.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">genFunc</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">yield</span> <span class="nx">genFunc</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Like functions, generators also have a call() and apply() methods which can be used
to invoke the function with an explicit context. The yield is there because when we
run this new function inside co(), the instantiated generator will be run and the
return value will be be spat out to be returned by this generator.</p>

<p>With that in mind, How about a function that takes two generators and runs one inside
the other? How would we impliment that?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">join</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gen1</span><span class="p">,</span> <span class="nx">gen2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">yield</span> <span class="nx">gen1</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">gen2</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this function in place, we can now run two generators back to back inside
a single coroutiine function.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;co&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">co</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">next</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">foo</span><span class="p">);</span> <span class="c1">// =&gt; &#39;hello world&#39;;</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">foo</span><span class="p">;</span>
</span><span class='line'><span class="p">},</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="s1">&#39;hello world&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">})).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are interested in exploring this subject further, I&#8217;m working on a javacript
library for composing generators called <a href="https://github.com/cultofmetatron/Shen">Shen</a>.
Its a toolkit for composing generators for running inside co like lego pieces.</p>

<p>To give you a taste of its power, Instead of join,
<a href="https://github.com/cultofmetatron/Shen">Shen</a> implements cascade which allows you to
merge 1 or more generators.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">shen</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;shen&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">co</span><span class="p">(</span><span class="nx">shen</span><span class="p">.</span><span class="nx">cascade</span><span class="p">(</span>
</span><span class='line'>  <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="c1">//each yield freezes the generator until the next returns.</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">yield</span> <span class="nx">next</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">yield</span> <span class="nx">next</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">shen</span><span class="p">.</span><span class="nx">cascade</span><span class="p">(</span>
</span><span class='line'>    <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">//thats right, you can nest them too!</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">yield</span> <span class="nx">next</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>  <span class="p">})))();</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Outputs</span>
</span><span class='line'><span class="cm">    1</span>
</span><span class='line'><span class="cm">    2</span>
</span><span class='line'><span class="cm">    3</span>
</span><span class='line'><span class="cm">    2</span>
</span><span class='line'><span class="cm">    1</span>
</span><span class='line'><span class="cm">  */</span>
</span></code></pre></td></tr></table></div></figure>


<p>Shen functions all compose with each other allowing you to put together generators
as easily as you would curry a function.</p>

<p>In addition to cascade and bind, Shen also currently includes&#8230;</p>

<ul>
<li>branch and dispatch for conditional logic</li>
<li>delay for&#8230; delaying?</li>
<li>parallel: run several generators and get back an array of the return values</li>
<li>oscillator: run a generator at a specific interval and get back an immediate event emitter
that fires with the latest returned value of the generator</li>
</ul>


<p>Current use-cases off the top of my head include using oscillator and parrallel to run several
network requests at the same time. you&#8217;d get an event emitter with all the returned values in
one place. One thing to note is that you can&#8217;t completely escape callbacks but you can create
areas in your code where callbacks are invisible. The generator takes care of the hard stuff.</p>

<p>Its still very much a work in progress and only works on node 0.11 but I invite you all to try it out.
If you want to help, I&#8217;m always welcome to new ideas for pieces to add to the ecosystem.
contributing a few tests or implementations of ideas would be great too!</p>

<p><a href="https://github.com/cultofmetatron/Shen">Here&#8217;s the github to the project</a></p>

<p>Cheers.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-08T19:12:00-08:00" pubdate data-updated="true">Feb 8<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ecmascript6/'>ecmascript6</a>, <a class='category' href='/blog/categories/functional-programming/'>functional-programming</a>, <a class='category' href='/blog/categories/generators/'>generators</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
	
		<span class="comments"><a href="/blog/2014/02/08/functional-programming-with-ecmascript6-generators//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2014/02/01/koa-zero-to-todo-list/">Koa: Zero to Todo List</a></h1>
	<div class="entry-content">
		<h2>Note: you need to run node 0.11 with &#8211;harmony to run the code.</h2>

<p>From the creators of express comes a brand new framework for node powered by
the new ecmascript 6 generators syntax. <a href="http://koajs.com/">Koa</a> is an interesting
reimagining of how we will be able to build web applications in javascript.</p>

<h3>The old paradigm</h3>

<p>In the standard node library, The &#8216;http&#8217; module is used to create servers.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
</span><span class='line'>  <span class="c1">//server logic goes here</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;listening on port 3000&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Express exposes a function that we can give to
http.createServer as a callback. Express middleware is a set of functions that
take 3 arguments, req, res and next. The middleware performs some operations, modifies
either the request or response objects and passed down to the next middleware in the stack
by calling next(). Its akin to a water flow model where the the response ends somewhere
near the end of the middleware stack.</p>

<h3>Enter Koa, The generators based framework</h3>

<p>Like express, Koa works internatlly by generating a callback that can be passed to
http.createServer().  Unlike Express, it uses generators to provide a much more fine grained
model of control flow.</p>

<p>A very basic koa app looks like this, lets make it serve up the contents of a file</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">koa</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">Promise</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bluebird&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//creates promise yielding versions of fs</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">));</span>
</span><span class='line'><span class="c1">//create the koa instance</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//here&#39;s an example middleware that logs to the console</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;timestamp: before request =&gt; &#39;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
</span><span class='line'>  <span class="nx">yield</span> <span class="nx">next</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;timestamp: after request  =&gt; &#39;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">&#39;./app.js&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;now listening on port 3000&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unlike Express, the middleware is written using generators.
Downstream middleware in Koa flows upstream on return. Middleware
yields down stream by explicitly calling &#8216;yield next.&#8217;. Upon return, the control
flow yields back up to where the upstream middleware yielded downstream.</p>

<p>Where Express passes native node req and res obects through to each function, Koa
manages a context where it encapsulates them behind an interface. They are still available
thrugh the &#8216;this&#8217; keyword as this.req and this.res. However, Its not reccomended in
the docs that you work with these native objects. One could imagine calling this.res.end(&#8221;)
would throw a monkey wrench in the control flow. Instead you are suppossed to work through
the this.response and this.request. Most of the methods are aliased directly to this. &#8216;this.body&#8217;
for example, is aliased to this.response.body.</p>

<p>There does not yet appear to be a direct way to get
to the request body. The co-body parser accesses the req.body directly so while the docs say
don&#8217;t do it, Koa is still young so you may have to get your hands dirty.</p>

<h3>A Todo app in koa</h3>

<p>Now that we&#8217;ve covered the basics, lets try something a little more complex. A todo
List seems like a good thing no one has ever tried to make before in any technology ever!
To simplify assumptions, lets just store the todos in memory.</p>

<p>By itself, Koa is very minimalistic. It does not provide body parsing, sessions, or
routing in the core. Unfortunatly Koa is still young so there just aren&#8217;t that many
npm modules for it just yet. A quick search on <a href="https://github.com/koajs/koa/wiki">the Koa website</a>
shows that we do have the necessary modules for a basic todo.</p>

<ol>
<li><a href="https://github.com/koajs/route">koa-route</a>: for routing</li>
<li><a href="https://github.com/visionmedia/co-body">co-body</a>: for parsing the body of post requests</li>
<li><a href="https://github.com/koajs/static">koa-static</a>: for serving up static assets</li>
</ol>


<p>Here&#8217;s the basic server side api</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//jshint esnext</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">koa</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">staticServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-static&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//this allows us to parse the native req object to get the body</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">parse</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;co-body&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">router</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-route&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">_</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">Promise</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bluebird&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">path</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">));</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>
</span><span class='line'><span class="c1">//our very basic data store</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//gets us unique ids</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//serve up the public directory where we have all the assets</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">staticServer</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/todos&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">    yield lets us pass asynchronous functions that return promises or thunks</span>
</span><span class='line'><span class="cm">    It will freeze the middleware till its resolved and pass it back in.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="p">(</span><span class="nx">yield</span> <span class="nx">parse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">todo</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">counter</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">todos</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">todos</span><span class="p">);</span>
</span><span class='line'><span class="p">}));</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/todos&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">todos</span><span class="p">);</span>
</span><span class='line'><span class="p">}));</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/todos/:id&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">todos</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">todos</span><span class="p">).</span><span class="nx">reject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;what? &#39;</span><span class="p">,</span> <span class="nx">todo</span><span class="p">,</span> <span class="nx">id</span> <span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">;}));</span>
</span><span class='line'><span class="p">}));</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;listening on port 3000&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/cultofmetatron/koa-todo">Download the code on github</a>
The github version includes frontend code.</p>

<h4>A few things of note:</h4>

<p>The &#8216;yield&#8217; keyword ca do some interesting things. If we pass into it
an asynchronous function that returns a thunk or promise, it will stop execution of
the middleware and wait till it resolves. It then returns the value of the promse or thunk
and resumes the generator. This is a hell of alot easier to read.</p>

<h4>A word of caution</h4>

<p>The &#8216;yield&#8217; keyword lets us do some safe blocking but it isn&#8217;t always the ideal solution.
While the event loop itself isn&#8217;t blocked by it the way futures can, it does block resuming
of any operations that occur after it.</p>

<p>For example, if we run three asyncronous operations top to bottom that do not depend on
each other, like the following&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">async1</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">async2</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">async3</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This completely defeats the purpose of node&#8217;s (almost automatic) concurrency. When we call
async1, we are blocking until async2 runs. This is unoptimal. It would be better to get the promises
for the three functions and yield on a merged promise.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">async1</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">async2</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">async3</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">]);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m excited to cut my teeth on sme bigger problems. As the frameowrk matures, Its going to
allow more fine grained control for how we write the next generation of web applications.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-01T17:12:00-08:00" pubdate data-updated="true">Feb 1<span>st</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ecmascript6/'>ecmascript6</a>, <a class='category' href='/blog/categories/generators/'>generators</a>, <a class='category' href='/blog/categories/harmony/'>harmony</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/koa/'>koa</a>


</div>
	
		<span class="comments"><a href="/blog/2014/02/01/koa-zero-to-todo-list//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2014/01/22/javascript-generators-first-impressions/">Javascript Generators: First Impressions</a></h1>
	<div class="entry-content">
		<p>Ecmascript 6 (harmony) is coming out soon and one of the most exciting features
it offers are generators. Generators are a minimalist flow control system that gives
a much finer grained level of control than we were afforded up till now.</p>

<blockquote><p>Note: the code in this blog will only run in node v0.11.x when run as &#8211;harmony.</p></blockquote>

<p>Like a function, a generator is an object that declares some behavior. Its first class
just like javascript functions and you can pass it around as values and return them from other
functions.</p>

<p>A generator is declared like a function only with a &#8216;*&#8217; before the parens.
We then create an instance of the generator by calling it.</p>

<p>Here&#8217;s a basic example.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">myGenerator</span> <span class="o">=</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">yield</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;this doesn&#39;</span><span class="nx">t</span> <span class="nx">get</span> <span class="nx">written</span> <span class="nx">until</span> <span class="nx">the</span> <span class="nx">second</span> <span class="nx">call</span> <span class="nx">to</span> <span class="nx">next</span><span class="p">()</span><span class="err">&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">myGenerator</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="c1">//=&gt; 5</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we run gen.next(), the code executes until we get to yield. The generator
then stops which is why the console.log() does not get called. The state of the
generator is returned by next which gives us two things.</p>

<ol>
<li>state.value: the value on the right side of the yield; in this case 5.</li>
<li>state.done: a boolean that returns true if there are no more yields in the generator.</li>
</ol>


<p>We&#8217;ve called gen.next() the one time. The second time we call gen.next(), we have the option
of passing in an argument to it that will be returned by yield inside the generator.</p>

<p>This example shows a more advanced example of bidirectional passing.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">myGenerator</span> <span class="o">=</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">firstWord</span> <span class="o">=</span> <span class="nx">yield</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">firstWord</span><span class="p">);</span> <span class="c1">//=&gt; &quot;hello&quot;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">secondWord</span> <span class="o">=</span> <span class="nx">yield</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">secondWord</span><span class="p">);</span> <span class="c1">//=&gt; &quot;world&quot;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">myGenerator</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span> <span class="c1">//=&gt; 5</span>
</span><span class='line'><span class="nx">state</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">);</span>
</span><span class='line'><span class="c1">//=&gt; &#39;hello&#39; gets printed to the screen from inside the generator</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span> <span class="c1">//=&gt; 10</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span> <span class="c1">//=&gt; false</span>
</span><span class='line'><span class="nx">state</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">//=&gt; &#39;world&#39; gets printed</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span> <span class="c1">//=&gt; 10</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span>  <span class="c1">//=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the biggest growing pains of javascript development is wrapping one&#8217;s
head around async programming and functions run asyncronously. Promises give us a
value that represents the eventual value returned from an asynchronous function.</p>

<p>Promises are promised in ecmascript 6 but they aren&#8217;t available when I run node 0.11
with &#8211;harmony  yet so I use <a href="https://github.com/petkaantonov/bluebird">Bluebird</a></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bluebird&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//extends node&#39;s fileSytem with versions of the async functions that return promises</span>
</span><span class='line'><span class="c1">//the promisified versions are the original name + &#39;Async&#39;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">&#39;.gitignore&#39;</span><span class="p">,</span>  <span class="s1">&#39;utf8&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span> <span class="c1">// prints the contents of the .gitignore file.</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;this runs before the callback passed to &quot;then&quot; which is counterintuitive.&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code Works because when the function is called, it creates a closure that doesn&#8217;t get
garbage collected because the function passed to the promise retains a reference to this scope.
When its called, it can operate on variables in this containing scope. However we
cannot return to the original function call. Thus Unless you are used to thinking about promises,
its a bit unintuitive that the console.log on the following line runs before the callback passed
to the then() handler of the promise.</p>

<p>Generators on the other hand, let us FREEZE the execution context until the file resolves.</p>

<p>There&#8217;s an excellent library called
<a href="https://github.com/visionmedia/co">co</a> from the creator of express that allows
us to create coroutines using generators. thus we could write the previous code using
generators.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bluebird&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">));</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;co&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">co</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">&#39;.gitignore&#39;</span><span class="p">,</span>  <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="c1">//this doesn&#39;t run until the previous function resolves.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">yield</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">&#39;package.json&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is pretty exciting, This Asyncrouous code looks downright synchronous. Its also running
in its own context so it doesn&#8217;t block the event loop. Within the generator, we can write
much more fine grained flow control for asynchronous functions.</p>

<p>That said, how does co work? The basic premise is that we use yield to pass back the promise
into co where it waits till the function resolves. Then we call the next() of this function
passing in the value from the resolved promise.</p>

<p>co itself is extremely flexible allowing you to pass in thunks, or A+spec promises into
yield. Here I&#8217;ll demonstrate a simplified version that can accept only promises.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">co</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fngen</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  next takes a instatiated generator and calls</span>
</span><span class='line'><span class="cm">  and a value returned from calling next on it</span>
</span><span class='line'><span class="cm">  gen is an instance of a generator</span>
</span><span class='line'><span class="cm">  yieldable is the value returned from calling gen.next()</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">yieldable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">yieldable</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//if </span>
</span><span class='line'>      <span class="c1">//we assume yieldable.value is a promise so we call then() to get the value</span>
</span><span class='line'>      <span class="nx">yieldable</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">        we call next on gen and pass in the value into gen.next() to </span>
</span><span class='line'><span class="cm">        inject the value back into out coroutine where it gets returned</span>
</span><span class='line'><span class="cm">        by the yield in the generator. </span>
</span><span class='line'><span class="cm">        </span>
</span><span class='line'><span class="cm">        By call gen.next(val), gen resumes execustion passing val back </span>
</span><span class='line'><span class="cm">        and gen.next() return when it hits the next yield keyword returning </span>
</span><span class='line'><span class="cm">        the value passed in to yield.</span>
</span><span class='line'><span class="cm">        */</span>
</span><span class='line'>        <span class="nx">next</span><span class="p">(</span><span class="nx">gen</span><span class="p">,</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">val</span><span class="p">));</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//instatiate the generator</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">gensym</span> <span class="o">=</span> <span class="nx">fngen</span><span class="p">();</span>
</span><span class='line'>    <span class="c1">//get the first yieldable</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">yieldable</span> <span class="o">=</span> <span class="nx">gensym</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">yieldable</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">next</span><span class="p">(</span><span class="nx">gensym</span><span class="p">,</span> <span class="nx">yieldable</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The concept is pretty simple, yield passed back the value on the right to gen.next()
which it returns. The value we pass into the gen.next call to gen.next() becomes
the value returned by yield. Sorta like a zig zag or a needle stitching.</p>

<p>I&#8217;m excited to see some of the new projects that will take advantage of this new
ecmascript 6 feature. One big example comming to mind is the new koa framework. Unlike
its predecessor express/connect, Koa is a set of pluggable middleware components
that utilize generators heavily for flow control.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-22T16:03:00-08:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/generators/'>generators</a>, <a class='category' href='/blog/categories/promises/'>promises</a>


</div>
	
		<span class="comments"><a href="/blog/2014/01/22/javascript-generators-first-impressions//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2014/01/06/lets-build-a-backbone-based-framework/">Lets Build a Backbone Based Framework!!</a></h1>
	<div class="entry-content">
		<p>I&#8217;ve been building large scale applications in Backbone for about 8 months now.
In that time I&#8217;ve used throax as well as building custom solutions in backbone.</p>

<p>Last night, I live coded the creation of a demo backbone framework similar in features
to Thorax. I&#8217;m going to walk you through how
I&#8217;ve solved architectural problems in contructing a large scale backbone framework.</p>

<p><a href="https://github.com/cultofmetatron/backbone-framework-example">Fork or watch it here</a></p>

<p>When building a large scale Backbone, there are several consderations to consider.</p>

<ul>
<li>How are we going to have templates load? Inline html declarations in the views do not scale</li>
<li>how do we handle render?</li>
<li>how do we handle child views?</li>
</ul>


<p>By default, backboneView.render() is a noop. Its meant to be overidden. Backbone.Events gives us
a nice set of methods to allow Backbone objects to listenTo() events off each other, However, the
actual bindings and callbacks are left to the implimenter.</p>

<h3>Loading Templates</h3>

<p>the first thing is figure out how we want the templates to load. If using a tool like require.js
or browserify, there are plugins for automatically compiling templates and sending to the client
just a compiled template function we can plug into out view. Since I&#8217;m trying to keep it simple,
the easiest way to get templates is to wrap your templates in a script tag. To prevent the browser
from executing it as javascript, we add a type that is not &#8216;text/javascript&#8217;.</p>

<p>I like to use &#8220;text/template.&#8221;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/template&quot;</span> <span class="na">data-name=</span><span class="s">&quot;templateName&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="c">&lt;!--</span> <span class="nx">template</span> <span class="nx">contents</span> <span class="nx">goes</span> <span class="nx">here</span> <span class="o">--&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Transforming these into working templates is fairly straightforward. For each
script tag with type=&#8221;text/template&#8221;, run the template compiler over the html inside and
store it somewhere. In this case I add a data-name attribute which will be the key for the
hash I store the compiled template in.</p>

<p><a href="https://github.com/cultofmetatron/backbone-framework-example/blob/master/public/javascripts/init.js">/public/javascripts/init.js</a></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$sources</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;script[type=&quot;text/template&quot;]&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$sources</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">templates</span><span class="p">[</span><span class="nx">$el</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">());</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this version, I chose to use express + jade, Of course writing underscore templates
in jade seemed a little odd so I delegated those to jade&#8217;s include statement. I know there
are projects like jade-browserify so maybe I&#8217;ll eventually update this using just jade.</p>

<p><a href="https://github.com/cultofmetatron/backbone-framework-example/blob/master/views/layout.jade">/views/layout.jade</a></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='jade'><span class='line'><span class="nt">doctype</span> html
</span><span class='line'><span class="nt">html</span>
</span><span class='line'>  <span class="nt">head</span>
</span><span class='line'>    <span class="nt">title</span><span class="p">=</span> <span class="n">title</span>
</span><span class='line'>    <span class="nt">link</span>( <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="err">,</span> <span class="na">href=</span><span class="s">&#39;/components/bootstrap/dist/css/bootstrap.css&#39;</span>)
</span><span class='line'>    <span class="nt">link</span>( <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="err">,</span> <span class="na">href=</span><span class="s">&#39;/stylesheets/style.css&#39;</span>)
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/components/jquery/jquery.js&quot;</span>)
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/components/bootstrap/dist/js/bootstrap.js&quot;</span>)
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/components/underscore/underscore.js&quot;</span>)
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/components/backbone/backbone.js&quot;</span>)
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/javascripts/base.js&quot;</span>)
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/javascripts/application.js&quot;</span>)
</span><span class='line'>  <span class="nt">body</span>
</span><span class='line'>    <span class="nt">block</span> content
</span><span class='line'>    <span class="nt">script</span>(<span class="na">type=</span><span class="s">&quot;text/template&quot;</span><span class="err">,</span> <span class="na">data-name=</span><span class="s">&quot;main&quot;</span>)
</span><span class='line'>      <span class="nt">include</span> templates/main.html
</span><span class='line'>    <span class="nt">script</span>(<span class="na">type=</span><span class="s">&quot;text/template&quot;</span><span class="err">,</span> <span class="na">data-name=</span><span class="s">&quot;header&quot;</span>)
</span><span class='line'>      <span class="nt">include</span> templates/header.html
</span><span class='line'>    <span class="nt">script</span>(<span class="na">type=</span><span class="s">&quot;text/template&quot;</span><span class="err">,</span> <span class="na">data-name=</span><span class="s">&quot;menuLinks&quot;</span>)
</span><span class='line'>      <span class="nt">include</span> templates/menulink.html
</span><span class='line'>    <span class="nt">script</span>( <span class="na">src=</span><span class="s">&quot;/javascripts/init.js&quot;</span>)
</span></code></pre></td></tr></table></div></figure>


<p>The actual contents of the underscore templates in the *.html templates will
now be compiled and loaded into &#8220;templates[data-name]&#8221; where I can access it later.</p>

<h3>Creating our own Base Backbone Objects.</h3>

<p>The first thing we want to do is determie the shared behavior of backbone objects
in our app. For special cases we can overide them later. However, for the sake of time, we
want some decalrative way of telling the object what template to use and a default render()
method that we can use in most situations.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//first we declare a namespace to store these new Objects</span>
</span><span class='line'>  <span class="nx">application</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="nx">application</span><span class="p">.</span><span class="nx">BaseView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">        if the BaseView is extended with a tpl string, we want to </span>
</span><span class='line'><span class="cm">        have that be available but we also want to be able to load </span>
</span><span class='line'><span class="cm">        it at runtime and have it overide the base tpl string</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tpl</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">tpl</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">loadTemplate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tpl</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">loadTemplate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/*  </span>
</span><span class='line'><span class="cm">        if tpl is a function, we assign it directly, </span>
</span><span class='line'><span class="cm">        otherwise, if its a string, we look it up</span>
</span><span class='line'><span class="cm">        in our templates map.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">tpl</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">tpl</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">tpl</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">[</span><span class="nx">tpl</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;tpl must be a function or a string!&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">//see below</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up we need to create a render function. Its arbitrary based on the particular
needs of your application. For most purposes however, Its sufficiant to make a
view&#8217;s model&#8217;s attributes available inside the templates.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//from the render in the preceeding example</span>
</span><span class='line'>  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="c1">//empty the view&#39;s node</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">//create a context object</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">context</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s a great first start. Now any View that extends BaseView will have a
render. The only interface we must follow is that the View have a model
and a tpl which tells the View how to resolve this.template.</p>

<p>Of course there&#8217;s a major component missing. Any good backbone framework
has a way of embedding subViews. Turns out its sort of tricky.</p>

<p>The Lifecycle of a Backbone view in this case is to listen to changes on
model and call render() which updates the view&#8217;s $el property. Thus its
impossible to proceed until this.$el is completely demystified.</p>

<h4>what is $el?</h4>

<p>I&#8217;ve heard alot of confusion about the nature of &#8216;this.$el&#8217;. Typically, a Backbone
View is a controller for a node. This node is a structure relevant to the
document object model.</p>

<p>you may be familiar with a dom object if you&#8217;ve used jquery.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">$body</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">);</span> <span class="c1">// =&gt; returns a jquery wrapped object</span>
</span><span class='line'>  <span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">//returns the wrapped object representing the body dom node.</span>
</span></code></pre></td></tr></table></div></figure>


<p>In much the same way, a backbone view is a controller for a dom object.</p>

<p>You may have seen the kickstart for a backbone app that involves doing a jquery
lookup on a node and setting its html to your view&#8217;s $el property</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">$container</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.container&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$container</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">$el</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Assuming the render() method of the view returns &#8216;this&#8217;, then calling it before calling the
$el property guarantees that the dom object managed by the view will be updated before being
placed in the dom. When render() is called again, it updates the <em>contents</em> of that $el. The
$container has a reference to $el stored in it thus ensuring that calling render() will change
the webpage to reflect the latest state of the model.</p>

<h4>Extending out Render() to support subViews.</h4>

<p>With the afformentioned definition of $el in mind, The best way to embed a subview
(with string based template engines, you do something else with dom based ones.) is to do an
initial render of the dom node marking off somehow places to embed subviews. Then afterwards,
go back through the $el and systematically embed $el for each subview in their respective places.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//updated render()</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="nx">context</span><span class="p">.</span><span class="nx">_subView</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">viewName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;&lt;div class=&quot;subView view-&#39;</span> <span class="o">+</span> <span class="nx">viewName</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">//pop it in the dom</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">context</span><span class="p">));</span>
</span><span class='line'>  <span class="c1">//notice we do this AFTER we rerender the new this.$el</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">subViews</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">subViews</span><span class="p">;</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.subView&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// view-</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">subView</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">classList</span><span class="p">)).</span><span class="nx">chain</span><span class="p">()</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">className</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="nx">className</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^view-/</span><span class="p">));</span>
</span><span class='line'>      <span class="p">},</span> <span class="k">this</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">className</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>      <span class="p">},</span> <span class="k">this</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">value</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//grab the first item</span>
</span><span class='line'>    <span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">subViews</span><span class="p">[</span><span class="nx">subView</span><span class="p">].</span><span class="nx">render</span><span class="p">().</span><span class="nx">$el</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span> <span class="k">this</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&#8217;s a new things we&#8217;ve added to this version.</p>

<ol>
<li>There is now a &#8216;subView()&#8217; helper being passed into context, this will generate
the slug that we will look for when embedding a subview.</li>
<li>After the $el is rendered, we are searching for dom elements with class subview</li>
<li>for each subView, we find the name of the subview we embed in there given as
view-[viewName] and look it up in the view&#8217;s subViews key/val lookup object.
Its a property of teh parent view.</li>
</ol>


<p>With this, we now have an easy way of supporting subviews.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">childView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">application</span><span class="p">.</span><span class="nx">BaseView</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">tpl</span><span class="o">:</span> <span class="s1">&#39;child&#39;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">parentView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">application</span><span class="p">.</span><span class="nx">BaseView</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">tpl</span><span class="o">:</span> <span class="s1">&#39;parent&#39;</span>
</span><span class='line'>    <span class="nx">subViews</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">child</span><span class="o">:</span> <span class="nx">childView</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.container&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">parentView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">$el</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In parentView&#8217;s template, its as simple as using out new subView helper</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/template&quot;</span> <span class="na">date-name=</span><span class="s">&quot;parent&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;%=</span> <span class="nx">_subView</span><span class="p">(</span><span class="s1">&#39;child&#39;</span><span class="p">)</span> <span class="o">%&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/template&quot;</span> <span class="na">date-name=</span><span class="s">&quot;child&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">span</span><span class="o">&gt;</span> <span class="nx">hi</span> <span class="nx">I</span><span class="err">&#39;</span><span class="nx">m</span> <span class="nx">the</span> <span class="nx">child</span> <span class="nx">view</span><span class="o">!!</span> <span class="o">&lt;</span><span class="err">/span&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the next installment in this series, we&#8217;ll build a base ControllerView class which we
can use to render generic collections. Yes, they&#8217;ll be embedable as subviews in our BaseView.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-06T13:57:00-08:00" pubdate data-updated="true">Jan 6<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/backbone/'>backbone</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
	
		<span class="comments"><a href="/blog/2014/01/06/lets-build-a-backbone-based-framework//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2013/07/16/lexically-scope-like-a-boss/">How to Lexically Scope Like a Boss</a></h1>
	<div class="entry-content">
		<p>Lexical scoping (scoping accordinng to location in source code) is probably one of
the most powerful features a programming language can have.
Today, I&#8217;m going to show you how to use lexical scoping to
create powerful abstractions. I will begin by introducing the concept of scope.
From there I will introduce a few rules for figuring out the scope of your variables
in javascript and then introduce the concept of a closure and how it will make you
positivly badass at Javascript.</p>

<h2>What is a scope?</h2>

<p>I&#8217;m assuming you have written code before. Hell, I&#8217;d dare assume you&#8217;ve written a <em>var.</em></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">variableName</span> <span class="o">=</span> <span class="s2">&quot;variable value&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>What does it mean to use the <em>var</em> keyword? As you may know, good javascript has you
prepend all your variables with var. Most will also advocate wrapping all your code in
an immediatly invoked function.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//this is being declared in the global scope.</span>
</span><span class='line'><span class="c1">//its functionally equivilant to window.foo or just plain foo</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;super bar&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;inner bar&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;this foo refers to the foo inside this function &#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'><span class="cm">/* I don&#39;t always create inline annonymous functions, but when I do, I</span>
</span><span class='line'><span class="cm">immediatly invoke them. Live dynamically my friends &lt;3 */</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;this one will print the top level: &#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s start with this relativly simple example to begin growing some understanding.
Internally, the interpreter/compiler represents scopes with a tree (in simple cases, just a linked list).
At each node in the tree is a dictionary of values that we refer to with the variable
names from your source code. When we refer to foo, the interpreter (or the compiler at compile time)
will look for it in the most immediate scope. If it doesn&#8217;t find a value there, it will look
up the scope tree until it finds a node with a matching key/val and uses it for the current instruction.</p>

<p>Look at that previous code sample. If there wasn&#8217;t a <em>var foo</em> at the top of the function,
The interpreter would look for scope[foo] and find that it isn&#8217;t there. It would then look for an
entry named <em>foo</em> in the current scope&#8217;s parent. That is the global scope where
the variable foo exists. It refers to the value &#8220;super bar.&#8221;</p>

<h2>Creating scopes and determining the current scope&#8217;s parent</h2>

<p>The rules for creating scopes differ between languages. In Javascript, we start new scopes with a
function.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;global scope&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">goo</span> <span class="o">=</span> <span class="s2">&quot;ber&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;inner scope&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;super inner scope bro!&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">})();</span>
</span><span class='line'><span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This creates a tree with three nodes we can visually represent
in pseudo-coffeescript.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nv">scope_chain = global:</span>
</span><span class='line'>                  <span class="nv">variables:</span>
</span><span class='line'>                    <span class="nv">foo: </span><span class="s">&quot;global scope&quot;</span><span class="p">;</span>
</span><span class='line'>                    <span class="nv">goo: </span><span class="s">&quot;ber&quot;</span>
</span><span class='line'>                  <span class="nv">children:</span>
</span><span class='line'>                    <span class="nv">inner_scope:</span>
</span><span class='line'>                      <span class="nv">variables:</span>
</span><span class='line'>                        <span class="nv">foo: </span><span class="s">&quot;inner scope&quot;</span>
</span><span class='line'>                      <span class="nv">children:</span>
</span><span class='line'>                        <span class="nv">super_inner_scope:</span>
</span><span class='line'>                          <span class="nv">variables:</span>
</span><span class='line'>                            <span class="nv">foo : </span><span class="s">&quot;super inner scope bro!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, we have three nodes and there are variables that are available
at each node. If you try to access a variable, the interpreter will look up the nodes
until it finds an entry that matches.</p>

<p>Lets go deeper. How about we not even bother with immediatly invoking the function.
How would that work?</p>

<p>The simple answer is that it changes nothing. The scope chain rules are consistent. The only difference
is that we now have two ways variables can enter the scope.</p>

<ol>
<li>Through the scope tree, variables in parent scopes are available.</li>
<li>When variables are injected in via the function arguments which can be
pulled from some other scope where we invoke the function.</li>
</ol>


<p>We delay the instantiation of the scopes until they are invoked later in the program.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//scope A</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">binder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">st</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//scope B</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">st</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//scope C</span>
</span><span class='line'>        <span class="nx">state</span> <span class="o">=</span> <span class="nx">newState</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//scope E</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Scope order is created lexically. Each new function definition in the source (ie: text, hence the lexical)
is being read into the interpreter as a place to mark a new node in the scope chain on invocation.
I mentioned that the scope datastructure resembles a tree because both Scope C and E
belong to B as siblings. B in turn, belongs to A.</p>

<p>None of these functions are being invoked but the scope lookup rules are locked to A -> B, B-> C, B->E
Things get hairier when we invoke them.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//scope A</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">b1</span> <span class="o">=</span> <span class="nx">binder</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">b1</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>   <span class="c1">// =&gt; 5</span>
</span><span class='line'>  <span class="nx">b1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// =&gt; 2</span>
</span><span class='line'>  <span class="nx">b1</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span> <span class="c1">// =&gt; 2</span>
</span></code></pre></td></tr></table></div></figure>


<p>How on earth is this function maintaining state? The Binder, on invocation, takes the argument 5
and creates a scope according to the rules set forward in the source code of binder.</p>

<p>Now, 2 is in Scope B and being assigned to the variable &#8220;state&#8221; we instantiated in scope B.
We then return the object back.</p>

<p>The object we get back from calling binder()  has two functions and thus two child
scopes of B, (C, and D) which  we return back to Scope A. via the return.</p>

<p>Now it gets weird. When we call b1.get(), we invoke a function from scope A
which internally has a scope C who&#8217;s parent scope is scope B. It thus returns a value from scope B
back into scope A. Think of it like a closed loop of scopes. ie: a closure. ;)</p>

<p>This is pretty powerful. b1.set() does something similar only its injecting a variable from scope
A containing 2 into scope E where it is assigned to a variable in scope B and subsuquently returned.
B1.get(), on its next invocation returns the same value stored in that variable from the same scope
into scope A, the top level context.</p>

<p>We can use this to create objects with completely encapsulated states.
This gives us a leg up when trying to wrangle asynchrounous processes.</p>

<p>Here&#8217;s an example of a function that runs a function passed as an argument after a delay.
while we wait for the function to fire,
we can register functions to be called when the function is resolved.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//scope A</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">delay</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//Scope B</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span><span class="p">;</span> <span class="c1">//how we track what the status of the internal state is</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span> <span class="c1">//where we are going to store the result of calling fn.</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">//where we store registered callbacks.</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">//Scope C</span>
</span><span class='line'>      <span class="cm">/* the scope chain from here is A -&gt; B-&gt; C</span>
</span><span class='line'><span class="cm">      this simply calls teh function and allows us to pass in the</span>
</span><span class='line'><span class="cm">      arguments as an array</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="nx">result</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span> <span class="c1">//call the function</span>
</span><span class='line'>      <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;done&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">//we run through all the functions in deps and run them one</span>
</span><span class='line'>      <span class="c1">//by one.</span>
</span><span class='line'>      <span class="nx">deps</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//Scope D</span>
</span><span class='line'>        <span class="nx">dep</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span> <span class="nx">timeout</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//the two objects being returned have access to this scope</span>
</span><span class='line'>    <span class="c1">//which allows us to invoke them to affect this internal </span>
</span><span class='line'>    <span class="c1">//environmental.</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//Scope E</span>
</span><span class='line'>        <span class="c1">//A -&gt; B -&gt; C</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;done&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">func</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">delay</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//Scope F</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">msg</span> <span class="o">+</span> <span class="s2">&quot; world&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span> <span class="p">[</span><span class="s2">&quot;hello&quot;</span><span class="p">],</span> <span class="mi">3000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//by passing this function to done, you guarantee that</span>
</span><span class='line'>  <span class="c1">//when the function passed into delay is called, it will pass</span>
</span><span class='line'>  <span class="c1">//the result into the function passed in here.</span>
</span><span class='line'>  <span class="nx">promise</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//Scope G</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//3000 milliseconds later</span>
</span><span class='line'>  <span class="c1">//&gt; &quot;hello world&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yeah its a wee bit contrived but it illustrates a point. By using a closure to wrap a
bunch of data into this enclosed space, we can hide away some
pretty sophisticated machinery to invert the responsibilty of control. Now the
object maintains the state of the async call to the file and we register functions
that it will call when the async call is resolved. This removes alot of overhead for managing
async functions.</p>

<p>In Node.js, we pass a callback into the third paramater  for the standard library functions.</p>

<p>What if we could apply the same principle and get an object we could pass along functions to
and know it will take care of running them when the file is available?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fileObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">result_data</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">result_error</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">deps_success</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">deps_fail</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">deps_always</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="nx">encod</span> <span class="o">=</span> <span class="nx">encoding</span> <span class="o">||</span> <span class="s1">&#39;utf8&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="nx">encoding</span> <span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">result_data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">result_error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result_error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">deps_success</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">fn</span><span class="p">(</span><span class="nx">result_data</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">deps_fail</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">fn</span><span class="p">(</span><span class="nx">result_error</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">deps_always</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fn</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">queueFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;done&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fn</span><span class="p">(</span><span class="nx">result_data</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">queueFunction</span><span class="p">(</span><span class="nx">deps_success</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">fail</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fn</span><span class="p">(</span><span class="nx">result_error</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">queueFunction</span><span class="p">(</span><span class="nx">deps_fail</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">always</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;pending&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">queueFunction</span><span class="p">(</span><span class="nx">deps_always</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fn</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">ret</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="nx">done</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">ret</span><span class="p">.</span><span class="nx">fail</span> <span class="o">=</span> <span class="nx">fail</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">ret</span><span class="p">.</span><span class="nx">always</span> <span class="o">=</span> <span class="nx">always</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//this exposes the status as a readonly property</span>
</span><span class='line'>  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">status</span><span class="p">;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hey, that wasn&#8217;t so bad. We return an object of three functions and
it will take care of running the appropriate functions based on the
status of the object&#8217;s internal async operation when its resolved.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">newFile</span> <span class="o">=</span> <span class="nx">fileObject</span><span class="p">(</span><span class="s1">&#39;./hello.txt&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">newFile</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;two &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">newFile</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;one &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">newFile</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;the file errored out. returned: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">newFile</span><span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;this always gets called&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>In short, lexical scoping and closures are pretty damn awesome.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-07-16T22:27:00-07:00" pubdate data-updated="true">Jul 16<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/scoping/'>scoping</a>


</div>
	
		<span class="comments"><a href="/blog/2013/07/16/lexically-scope-like-a-boss//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2013/07/05/thorax-is-awesome/">Thorax Is Awesome</a></h1>
	<div class="entry-content">
		<p>I like Backbone.js a lot. It&#8217;s a fantastic utlity library for building your own
best of breed javascript applications. It is much more configurable than Angular
or Ember - both of which make numerous assumptions about the nature of your app,
which may or may not lead to frustration when working with a legacy codebase. While
you certainly won&#8217;t be cranking out apps as quickly as you would in more magical frameworks,
Backbone gives you enough to get started. It stays slim in features to avoid stepping
on your toes. Backbone is the fixed gear bike of frontend javascript frameworks.</p>

<p>I recommend anyone new to Backbone build a few projects to learn it. In practice,
I don&#8217;t recommend using Backbone alone for building out a full mvc system. Its missing
a few really important features that you would have to implement yourself.</p>

<h2>Enter Thorax</h2>

<p>In the world of Backbone extensions, there are three major players, Marionette, Thorax, and
Chaplain. I haven&#8217;t looked at Chaplain and I found Marionette heavy for my needs.
Thorax on the other hand, was a breath of fresh air. I especially loved the
<a href="http://handlebarsjs.com">handlebars.js</a> templates integration.</p>

<p>In the following posts, I will outline some of the major benefits of using Thorax.</p>

<ul>
<li>Out of the box render() that works</li>
<li>Child view management</li>
<li>Layout Views</li>
<li>The MVC in Backbone&#8217;s MVC</li>
</ul>


<h4>Out of the box render() that works</h4>

<p>Backbone.View&#8217;s default render method is a noop(), (ie: function() {}).
Backbone&#8217;s author&#8217;s intend for you to write your own render function which
sets its instance&#8217;s <em>el</em> property to your view&#8217;s generated representation of
the model&#8217;s data. Backbone avoids adding in this feature to keep it agnostic to
your templating system.</p>

<blockquote><p>Note: Handlebars</p>

<p>Handlebars is an html templating language for javascript.</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nx">value</span> <span class="p">}}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="p">{{</span><span class="err">#</span><span class="k">if</span> <span class="nx">foo</span><span class="p">}}{{</span><span class="nx">foobar</span><span class="p">}}{{</span><span class="err">/if}}&gt;.</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Handlebars</h3>

<p>This handlebars code is fed into Handlebars.compile() which returns a template function.
This function is then passed a &#8220;context&#8221; object. example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nx">value</span><span class="o">:</span> <span class="s2">&quot;hello there&quot;</span>
</span><span class='line'>      <span class="nx">foo</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">foobar</span><span class="o">:</span> <span class="s2">&quot;hello Douglas&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and generates a string of html that you can inject into the dom.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;h1&gt;</span>hello there<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>  <span class="nt">&lt;p&gt;</span>hello Douglas<span class="nt">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since Thorax makes the decision of using Handlebars, it can give us a default render()
method that&#8217;s usable rather than a noop(). Thorax.View.render() constucts a
context object containing all of the <em>properties</em> of the view instance and the attributes
of the model which is passed into the Handlebars template function so that it&#8217;s available
in the rendered view.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//render function, this is what a Thorax render does, </span>
</span><span class='line'><span class="c1">// *this* resolves to the thorax instance</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//get the attributes of the property</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">viewProperties</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">viewProperties</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="c1">//underscore.js&#39;s extend</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">viewProperties</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">viewProperties</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">viewProperties</span><span class="p">));</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default, properties of the view insance get passed to the template
but not the functions. What if we want to overide this?</p>

<p>In the past, I would write view helpers in order to render attributes that required computation.
There&#8217;s a more elegant way using the
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty">defineProperty</a> function.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">peter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;Peter&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">lastName</span><span class="o">:</span>  <span class="s1">&#39;de Croos&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">githubHandle</span><span class="o">:</span> <span class="s1">&#39;Cultofmetatron&#39;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">PersonView</span> <span class="o">=</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">template</span><span class="o">:</span>
</span><span class='line'>      <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="s2">&quot;we can call</span>
</span><span class='line'><span class="s2">               {{firstName}}, </span>
</span><span class='line'><span class="s2">               {{lastName}} and </span>
</span><span class='line'><span class="s2">               {{fullName}}&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;fullName&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;lastName&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span> <span class="c1">// see note below</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">peterView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PersonView</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">model</span><span class="o">:</span> <span class="nx">peter</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Technical note:</em> By default, properties defined by <em>defineProperty</em> are not enumerable.</p>

<p>IE: They won&#8217;t show up when you do the <em>for (property in this) {}</em>. Because
thats how thorax&#8217;s render view gets at the attributes, it won&#8217;t show up in the template
either. Luckily that is easy enough to fix by specifying the option
<em>enumerable:true</em></p></blockquote>

<h4>Child view management</h4>

<p>Backbone does nothing to address embedded views. It expects you to write your own logic
for handling child views in the render function. As you can imagine, it is kind of a pain.
It sounds simple enough in theory, but in practice it means that you have to write code to check
if a parent view is being removed and recursivly have it descend into all it child views to
undelegate events from the dom. This is a major potential source of javascript memory leaks.
Thorax provides some great helper functions for this. It just wins.</p>

<p>Thorax.Views can be embedded in another view simply by adding the subview as a property.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">blogModel</span> <span class="o">=</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;console.log(this.thought)&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">post</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Thorax is awesome&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">content</span><span class="o">:</span> <span class="s2">&quot;maximum callstack exeeded&quot;</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">PostView</span> <span class="o">=</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">template</span><span class="o">:</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="s1">&#39;&lt;h2&gt;{{title}}&lt;/h2&gt;&lt;p&gt;{{content}}&lt;/p&gt;&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">blogView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlogView</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">template</span><span class="o">:</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="s2">&quot;&lt;h1&gt;{{name}}&lt;/h1&gt;{{view postView}}&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">model</span><span class="o">:</span> <span class="nx">blogModel</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">postView</span><span class="o">:</span> <span class="k">new</span> <span class="nx">PostView</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, it was as easy as embedding  {{view postView }}
inside the template and Thorax takes of care of yielding control of that region to the
child view.</p>

<h4>Layout Views</h4>

<p>Let me just say that layout views are really awesome. A layout view is
a view with the sole purpose being a container which can hold whatever
view/model combo fits the current context.</p>

<h5>The MVC in Backbone&#8217;s MVC</h5>

<p>There&#8217;s a Backbone.Model and a Backbone.View but where is Backbone.Controller? (hint: there isn&#8217;t one)</p>

<p>Currently Marrionette augments Backbone with a Controller object but
Thorax does nothing of the sort. I guess the real question is, where does a controller fit?</p>

<p>Philosphically, MVC stands for a seperation of concerns between</p>

<ol>
<li>Models: the data containing the application logic we are modelling on the computer</li>
<li>Views: Objects that manage the presentation of the models. This includes binding
event handlers and rerendering when the underlying model(s) change.</li>
<li>Controllers: Objects that take care of managing what view and model are relevant.</li>
</ol>


<p>In the Rails world, the architectural philosphy revolves around the concept
of skinny controller/fat Model. The brunt of the code for manipulating the models should
be inside the instance methods in the models themeselves and the controller interacts with it
through an api.</p>

<p>When we really get down to it, controllers perform a few functions.</p>

<ol>
<li>Watch out for some event that should trigger a change in view and/or model.</li>
<li>Manage the creation of new view instances to represent new or altered models.</li>
<li>Render html and insert it into the DOM.</li>
</ol>


<p>Our controller will handle only the details of getting the proper model and binding
it to a view so that it can be rendered.</p>

<p>Lets create a function PostController that does nothing more than lookup a
model by its id and creates a post view.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">postController</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//for info on Thorax.Views, Thorax.Models and Thorax.Collections,</span>
</span><span class='line'>  <span class="c1">//see the note below</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">postView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">FullPagePostView</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">model</span><span class="o">:</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">Collections</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">postId</span><span class="p">)</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">postView</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p> <strong>Note</strong> About Thorax Registries</p>

<p> Thorax provides a Registry: a series of hashes
 where you can store the Constructor Functions for your
 extended models and views.</p>

<p> For more information visit <a href="http://thoraxjs.org/api.html#registry">The throax docs</a></p></blockquote>

<p>Now we have a basic controller that handles cases 2 and 3 of our list. We still need to take care
of figuring out how we want to determine when this controller gets called. In the projects
I have worked on, I&#8217;ve solved this problem using the router.</p>

<p>Thorax does nothing special with the router so we will use Backbone.Router as is. It will manage one
Layout view, a special Thorax view made for holding other views.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//router.js</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">layoutContainer</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">callController</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//arguments is used to shift responsibilty of knowing the </span>
</span><span class='line'>    <span class="c1">//amount of paramaters to the controller</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">layoutContainer</span><span class="p">.</span><span class="nx">setView</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function <em>callController</em> takes a controller, passes along
the arguments given to it by the router and takes care of the
boiler plate of creating a view and setting it into the container.
<em>layoutContainer.setView()</em> takes care of undelegating events of
all elements attached to the previous view (if there was a previous view)
as it swaps in the html of the new view.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//continued from above</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">layoutContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Thorax</span><span class="p">.</span><span class="nx">LayoutView</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;#AppLayout&#39;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">      this is the point in the html where our container will be </span>
</span><span class='line'><span class="cm">      injected in. from here on out, the router and controller</span>
</span><span class='line'><span class="cm">      system will take care of swappng out application views </span>
</span><span class='line'><span class="cm">      within this container.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="nx">layoutContainer</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;#entry-point&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;popstate&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;posts/:postId&#39;</span><span class="o">:</span> <span class="s1">&#39;postRoute&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">postRoute</span><span class="o">:</span> <span class="nx">callController</span><span class="p">(</span><span class="nx">postController</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a pretty straight forward setup with one possible new thing. So you
probably noticed the <em>$(document).trigger(&#8216;popstate&#8217;)</em>. In standard backbone,
the application instance Router has a method <em>navigate()</em> usually called by</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s1">&#39;path/to/route&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">trigger</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The trigger true is needed by backbone for the router to trigger any associated actions.
The browser by default writes to history when the document recieves the
<a href="https://developer.mozilla.org/en-US/docs/Web/Reference/Events/popstate">popstate</a> event.
The browser triggers popstate automatically when you enter a page or hit the backwards or forward buttons.
When you click back, the new url will load and the router which is listening
for the popstate event on &#8216;document&#8217; will perform the behavior associated with that url.</p>

<p>By having the <em>$(document).trigger(&#8216;popstate&#8217;)</em> at the end of the initialization, we guarantee
that once the router is finished initializing, it will read in the url and trigger the appropriate
context for the app for the url. This is great if we want multiple url entry points through
which the user enters the app. The user gets the same javascript no matter what url of the
website they visit. The app takes care of loading the right content based on the url.</p>

<p>Finally, the template option that was passed into the instantiation of layoutView is optional.
By default, Thorax wraps the layout in a div tag. We can customize the layoutView by giving it a template
and using the layout-element helper in that template.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">id=</span><span class="s">&quot;appLayout&quot;</span> <span class="na">type=</span><span class="s">&quot;handlebars/template&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>   <span class="p">{{</span><span class="nx">layout</span><span class="o">-</span><span class="nx">element</span> <span class="nx">tag</span><span class="o">=</span><span class="s2">&quot;div&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;currentContext&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="p">}}</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-07-05T13:45:00-07:00" pubdate data-updated="true">Jul 5<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/backbone/'>backbone</a>, <a class='category' href='/blog/categories/defineproperty/'>defineProperty</a>, <a class='category' href='/blog/categories/thorax/'>thorax</a>


</div>
	
		<span class="comments"><a href="/blog/2013/07/05/thorax-is-awesome//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2013/06/02/backbone-primer/">Backbone, a Short Primer - Part 1: Models and Events</a></h1>
	<div class="entry-content">
		<p>Its been a few months since I&#8217;ve started using backbone on my personal projects.
Its a great library for rolling out MVC structure into your application but the
learning curve is pretty brutal.</p>

<p>The first step to really understanding the backbone.js framework.</p>

<h3>There is no framework</h3>

<p>Seriously, get it out of your head entirely that backbone is a frameowrk. Its far
too minimal. Backbone is more like a toolkit library for contructing MVC frameworks.</p>

<p>Backbone provides the following objects</p>

<ul>
<li><a href="http://backbonejs.org/#Model">Backbone.Model</a></li>
<li><a href="http://backbonejs.org/#Collection">Backbone.Collection</a></li>
<li><a href="http://backbonejs.org/#View">Backbone.View</a></li>
<li><a href="http://backbonejs.org/#Router">Backbone.Router</a></li>
</ul>


<p>The real key is how we use it. Like Chess, it can be
learned very quickly. the problem is that you also need to understand the tactics and strategies.
The offical docs leave a lot to the imagination and the examples are lackluster at best if they
exist at all.</p>

<h3>Backbone.Model</h3>

<p>Backbone.Model is a storage container where we can add and remove
items via <em>set</em> and <em>get</em> attributes.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">newModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">newModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nx">bar</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">newModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="c1">// =&gt; &#39;bar&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may be wondering why you don&#8217;t use <em>newModel.foo = &#8216;bar&#8217;?</em>
The real power in backbone is in the
events that models can fire. By having you access the model&#8217;s attributes via
<em>set</em> and <em>get</em>, you ensure that the associated callbacks get fired everytime
an attribute is changed.</p>

<p>For example, in a View containing a Model,
when we change an attribute on the model via the setter and getter methods.
A callback automatically makes the model emit a &#8216;change&#8217; event which we can set
the view to listen to and trigger a rerender.</p>

<h4>Extending Backbone.Model</h4>

<p>Backbone.Model is inherited using extend. This is also where we add methods
that may be specific to our particular subclass of Backbone.Model. For instance,
lets create a Comments model which may contain a username, content, rating
and timestamp.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">Comment</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>    <span class="c1">//defaults are self explanatory</span>
</span><span class='line'>    <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">rating</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * initialize runs whenever new is called, it takes care of</span>
</span><span class='line'><span class="cm">     * setting up __super in the inheritance chain</span>
</span><span class='line'><span class="cm">     * there is also &#39;constructor&#39; which overides the contructor entirely</span>
</span><span class='line'><span class="cm">     * leaving you to manually impliment the prototype chaining.</span>
</span><span class='line'><span class="cm">     * ie: only use constructor if you know what you are doing.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="nx">getCurrentUser</span><span class="p">());</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">upvote</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* now we initialize the model passing in values in an object. */</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">newComment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">content</span><span class="o">:</span> <span class="s2">&quot;backbone needs a library for reactive databindings&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">newComment</span><span class="p">.</span><span class="nx">upvote</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">);</span> <span class="c1">// =&gt; 1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we&#8217;ve set up a basic backbone model for setting representing a comment.
In defaults, we put in an object of default attributes. You may be wondering why I
set up the owner and timestamp attributes in <em>initialize.</em></p>

<p>The defaults object and anything inside it is evaluated into a static object
inside the extend function call. Thus, if you were to try this</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="kd">var</span> <span class="nx">Comment</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>    <span class="c1">//defaults are self explanatory</span>
</span><span class='line'>    <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">rating</span>    <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">owner</span>     <span class="o">:</span> <span class="nx">getCurrentUser</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">timestamp</span> <span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">})();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>you would find that every instance will have the same timestamp. To get around this,
I have the functionality for those defaults set to run in initialize.</p>

<h4>Backbone.Model events</h4>

<p>Backbone models should only broadcast events in order to notify things that
contain it. A model itself can contain another model as an attribute.</p>

<p>Backbone.Model&#8217;s &#8216;change&#8217; event fires when it detects a change in the value of the attribute.
If the value is a model, then a change in that model&#8217;s attributes won&#8217;t change the reference
to the model. Unlike the dom, we have to explicitly set up our own event bubbling.</p>

<p>To set up your own event delegation, you have to set up a listener in the parent model to listen for
events in the attribute model.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">CommentHolder</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/* We set up event listeners here</span>
</span><span class='line'><span class="cm">        the first argument is message being fired</span>
</span><span class='line'><span class="cm">        the second is the function to be invoked</span>
</span><span class='line'><span class="cm">        the third is the context for function to be called in</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bubble</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">bubble</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// apply is used to propegate all possible arguments</span>
</span><span class='line'>      <span class="c1">// that can be coming form multiple events.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="c1">//trigger is a backbone function</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://backbonejs.org/#Events-catalog">&#8216;all&#8217;</a> is a backbone defined catch all event
that sends along the name of the event as the first argument. The model will listen
to its comment and broadcast any messages it recieves to any who would hear.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-02T14:42:00-07:00" pubdate data-updated="true">Jun 2<span>nd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/backbone-js/'>backbone.js</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/models/'>models</a>, <a class='category' href='/blog/categories/mvc/'>mvc</a>


</div>
	
		<span class="comments"><a href="/blog/2013/06/02/backbone-primer//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2013/04/12/processes-in-node-pid-to-kill/">Processes in Node Part 2: Pid to Kill</a></h1>
	<div class="entry-content">
		<p>Internally within node, every object has an id that V8 uses to keep track of these
object. In the same way, when we invoke a request to the operating system to create
a process, the operating system loads the program into memory and assigns it an id
which can be used to track the running program throughout its life cycle.</p>

<p>The id this process is assigned is called a pid and it can be accessed from within
node via process</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">pid</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pid</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Fun fact</em>: if you open another terminal and type &#8220;kill -9 (process pid).&#8221; You will
have effectivly terminated the process in the other window by having the operating
system directly deliver a kill switch to your running node instance.</p>

<p>The process module is global so we don&#8217;t need to require it. It gives us alot of
information about the running node instance that we can use in our programs.</p>

<p>Example operations include</p>

<ul>
<li>exiting the program</li>
<li>changing directories/ getting directory information</li>
<li>getting the name of the directory of the start script</li>
<li>retrieving argumenst passed into the command line invocation of the script</li>
</ul>


<h4>process events</h4>

<p>specific to node.js is the ability to bind to occur at process events.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">runOnExit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;...exiting&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/* its important that you do not invoke</span>
</span><span class='line'><span class="cm">    * any asynchronous functions in here</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="nx">runOnExit</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the case of exit, the event loop terminates. The documentation specifically
mentions events scheduled with setTimeout. Its important to note that this applies
to all asych events as they all operate on setTimeout underneath.</p>

<p><em>Consequently, if you need to write some pertinent information to the disc, Be sure
to use writeFileSync!!</em></p>

<h4>process.kill</h4>

<p>TLDR: Processes can send signals to each other and recieve signals from the ernal</p>

<p>Signals can be compared to events
and event listeners in javascript. kill()&#8217;s name is unfortunate since kill
is really a function for sending messages to other processes as OS signals. You will
use this function to tell other processes to go kill themeselves most of the time.</p>

<p>This isn&#8217;t limited to node processes speaking amongst themeselves. Ever run node and then
exit it using <em>ctrl-c.</em></p>

<p>For a great list of standard unix signals, check out this
<a href="http://people.cs.pitt.edu/~alanjawi/cs449/code/shell/UnixSignals.htm">Awesome Chart</a></p>

<p>We can orginaize them according to their default behaviors.</p>

<ul>
<li>kill requests/reports</li>
<li>error reporting</li>
<li>device access notification</li>
<li>coordinating io</li>
</ul>


<p>We can overide the default behaviors for some of these signals.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;to delete =&gt; kill -9 &quot;</span> <span class="o">+</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n\n this is a a reinforced program, it will not easily die&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* SIGINT is sent to your process when you type in CTR-C.</span>
</span><span class='line'><span class="cm">     the operating system intercepts this command and relays</span>
</span><span class='line'><span class="cm">     it to your node instance. node&#39;s default response is to exit.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SIGINT&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;you tried to press CTRL-C, go ahead, try again&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SIGTSTP&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;LOL, nope - CTRL-Z won\&#39;t save you!! either&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="c1">//this keeps the program from exiting</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">mainLoop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">mainLoop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">};</span>
</span><span class='line'>  <span class="nx">mainLoop</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>A more realistic scenario would be a situation in which you need to
write some files to the disk before kicking off the exit procedures.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SIGINT&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;writing to disk&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">saveData</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You cannot overwrite the kill -9 signal. This is why certain programs can become corrupted
when you kill-9 them. they are not given a chance to save state.</p>

<p>For more information about signals, I found these two guides to be excellent.</p>

<ul>
<li><a href="http://www.workingwithunixprocesses.com/?utm_source=jstorimer.com&amp;utm_medium=blog&amp;utm_campaign=bookspage">Working with Unix Processes</a></li>
<li><a href="http://www.amazon.com/The-Linux-Programming-Interface-Handbook/dp/1593272200/ref=sr_1_1?ie=UTF8&amp;qid=1366589402&amp;sr=8-1&amp;keywords=linux+programming+interface">The linux Programming Interface</a></li>
</ul>


<p>Signals are a primitive pipeline for relaying messages. If you are looking to build some
form of complex communication pipeline between individual processes,
you are better off doing so over tcp. There are frameworks that facilitate
this such as <a href="http://www.zeromq.org/">zeromq</a> with an
excellent <a href="https://github.com/JustinTulloss/zeromq.node">node binding available</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-04-12T10:22:00-07:00" pubdate data-updated="true">Apr 12<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/fork/'>fork</a>, <a class='category' href='/blog/categories/node/'>node</a>, <a class='category' href='/blog/categories/process/'>process</a>


</div>
	
		<span class="comments"><a href="/blog/2013/04/12/processes-in-node-pid-to-kill//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2013/04/11/processes-in-node-introduction/">Proceses in Node Part 1: Introduction to Processes</a></h1>
	<div class="entry-content">
		<p>As a language made to exist within the browser, javascript did not originally
come with a way to do process process related tasks. Until Chrome, browser based
javascript was running within the same process as the browser.</p>

<p>In Chrome, every tab runs in its own process. Consequently, your javascript on any given
page runs in its own process. Now that node has brought javascript into the server and far from
the restrictive confines of the browser, We can do intersting things like run other programs from node.</p>

<h3>What is a process?</h3>

<p>Much like the relationship between a Constructor function + its prototypye and the
object created by invoking the <em>new</em> keyword, a process is an operating system level invocation
of some program.</p>

<h3>Process vs Program - a very high level overview</h3>

<p>Imagine the hardrive that powers your computer. Stored on it is a long range of numbers.
For all practical purposes, we can think of it as a long serial stream of bits layed out. with information
encoded on them. At some magical location is the boot sector. When the computer first starts running,
it startsloading binary data from the hardrive into the RAM and then loads this data into the cpu.
At this point we load the master process which we call the operating system kernal.
The kernal then takes care of managing other processes in the system.</p>

<p>At this point, we get to your program. If we were doing this in <em>C</em>, the the compiler would compile your
source code into binary code which follows an executable format. The actual encoding of this binary instruction
stream varies across cpu architectures and operating systems. They do happen to share some
common characteristics. Most of this information is located in the header of the file as information that tells
the operating system that this code is executable and information on how it is to be run.</p>

<h5>Entry Point Address</h5>

<p>At some point in the binary stream of bytes that is your program, there exists the first instruction that
needs to be loaded into the cpu. The Operating System loads this address into memory and queues it up
for running into the cpu.</p>

<h5>Data</h5>

<p>Constants in the process are stored in the data stream in some area where they can be accessed by the
Process as it runs. This includes mathematical constants such as Math.PI or string error messages.</p>

<h5>Symbol and Lookup Tables.</h5>

<p>To properly explain symbol and lookup table, I need to elaborate on what is going on at the
instruction level on your computer. Basicly, it stores the locations of all the variables and function
entry points. in memory.</p>

<h3>Processes verses threads</h3>

<p>The simple $2 answer is that processes have their own copy of all the data and symbol information. In some languages, multiple threads exist within a process and all share the same data. more importantly, you cannot create threads in node.</p>

<h3>Processes and node</h3>

<p>For us nodesters, the picture gets a bit more complicated. The computer loads up the program instructions
we affectionatly know as node and loads it into memory. From there, the node program as a static set of
bits on the hardrive becomes an almost living thing that loads your javascript into memory and run it!</p>

<p>To clarify, the process running when you run your node program is an instance of the node program. You can
have several node instances running in memory. They can even all serve http requests as long as they are
not trying to bind to the same port.</p>

<p>Understanding processes is incredibly useful. In Ruby, processes forking is used heavily in the design of
<a href="http://unicorn.bogomips.org/">unicorn</a>. Services like nodejitsu and heroku utilize smart people who understand
how processes work to architect systems that run and manage your code on the cloud. More importantly, node code
can only run on one processor at any given time but by using features such as <em>fork</em>, you can set up a master
node process that delegates tasks to subprocesses it spawns yourself. Since node processes are so
lightweight, you could concievably run hundreds on your system at the same time.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-04-11T14:26:00-07:00" pubdate data-updated="true">Apr 11<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/node/'>node</a>, <a class='category' href='/blog/categories/process/'>process</a>, <a class='category' href='/blog/categories/systems/'>systems</a>


</div>
	
		<span class="comments"><a href="/blog/2013/04/11/processes-in-node-introduction//index.html#disqus_thread">Comments</a></span>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2013/03/31/on-this-protototypes-and-dunderheads/">On This, Protototypes, and Dunderheads</a></h1>
	<div class="entry-content">
		<p>Of all the stranger than fiction things I have seen, I can&#8217;t say I have experienced as blatant
a miscarriage of conceptual understanding as I have with javascript&#8217;s object system. (Ok, I might
be exagerating just a little&#8230;)</p>

<p>Javascript is an interesting language. It is quite powerful when paired with appropriate libraries
like <a href="http://underscorejs.org/">underscore</a>. Its prototypical inheritence model is a mindblowlingly powerful reductionist critique
of classical inheritance. In the right hands, functions become lego pieces that can be glued onto objects
in staggeringly flexible ways.</p>

<h3>On &#8220;this&#8221;</h3>

<p>Lets take an object</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">myObject</span> <span class="o">=</span> <span class="p">{};</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a basic object. It is also a hash.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">//We can access it via dot notation or hash notation</span>
</span><span class='line'>  <span class="nx">myObject</span><span class="p">[</span><span class="s1">&#39;jackson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>  <span class="mi">5</span> <span class="o">+</span> <span class="nx">myObject</span><span class="p">[</span><span class="s1">&#39;jackson&#39;</span><span class="p">];</span> <span class="c1">// =&gt; 10;</span>
</span><span class='line'>  <span class="mi">5</span> <span class="o">+</span> <span class="nx">myObject</span><span class="p">.</span><span class="nx">jackson</span><span class="p">;</span>    <span class="c1">// =&gt; 10;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//we can store strings, numbers, other objects and very importantly,</span>
</span><span class='line'>  <span class="c1">// other functions!</span>
</span><span class='line'>  <span class="nx">myObject</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;this is the Jackson &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">jackson</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">myObject</span><span class="p">.</span><span class="nx">title</span><span class="p">()</span> <span class="c1">// =&gt; &quot;this is the Jackson 5&quot;;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are currently a javascript programmer, you&#8217;ve probably seen code like this. In
langages like Java, or c, Functions are simply routines that operate on code. they are static.
Once they exist, they exist in only one context. The Java version of <em>&#8216;this&#8217;</em> refers to the instance
of the instantiated object.</p>

<p>Functions in javascript are &#8220;First Class.&#8221;
This is a really important distinction to make because it enables all of the most
powerful code reuse techniques. A function can exist beyond an object. It can be made an
instance function a several different objects. In practice, it means we can assign functions to
variables and pass it into functions as arguments. We can even return functions from other functions.</p>

<p>Put more succinctly&#8230;</p>

<p>We can create a function which performs operations related to an abstract &#8220;this&#8221; attribute without knowing what &#8220;this&#8221; is going to be till we hook up a context to it when its called.</p>

<p>It is important to discuss the notion of call time.  Languages where functions are not first class
do not have a call time.</p>

<p>Lets take a cannonical example in Java.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleClass</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="n">foo</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Clojure is way more fun&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">ExampleClass</span><span class="o">(</span><span class="kt">int</span> <span class="n">foo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// initialize code goes here</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">foo</span> <span class="o">=</span> <span class="n">foo</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">getFoo</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">foo</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Java functions are not first class. The <em>&#8216;this&#8217;</em> refers only to the instantiated instance of
this class. If I instantiate this class and call the function, I will get the
class variable &#8220;foo&#8221; of the instance.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="n">ExampleClass</span> <span class="n">exampleClass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExampleClass</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> <span class="c1">// Java is ridiculous!!!</span>
</span><span class='line'>  <span class="n">exampleClass</span><span class="o">.</span><span class="na">getFoo</span><span class="o">();</span> <span class="c1">// =&gt; 5</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// this results in an error because there is no public variable getFoo</span>
</span><span class='line'>  <span class="n">exampleClass</span><span class="o">.</span><span class="na">getFoo</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because Java&#8217;s functions are not first class, there is no notion of this function being
referred to unless its being specifically called. Javascript&#8217;s functions are dfferent. I can declare
a javascript function and bind it to several objects.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">getFoo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span><span class="mi">1</span> <span class="p">};</span>
</span><span class='line'>  <span class="nx">first</span><span class="p">.</span><span class="nx">getFoo</span> <span class="o">=</span> <span class="nx">getFoo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="mi">2</span> <span class="p">};</span>
</span><span class='line'>  <span class="nx">second</span><span class="p">.</span><span class="nx">getFoo</span> <span class="o">=</span> <span class="nx">getFoo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">third</span> <span class="o">=</span> <span class="p">{</span><span class="nx">foo</span><span class="o">:</span><span class="mi">3</span><span class="p">};</span>
</span><span class='line'>  <span class="nx">third</span><span class="p">.</span><span class="nx">theNameIsIrrelevant</span><span class="o">=</span> <span class="nx">getFoo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">first</span><span class="p">.</span><span class="nx">getFoo</span><span class="p">()</span> <span class="c1">// =&gt; 1</span>
</span><span class='line'>  <span class="nx">second</span><span class="p">.</span><span class="nx">getFoo</span><span class="p">()</span> <span class="c1">// =&gt; 2</span>
</span><span class='line'>  <span class="nx">third</span><span class="p">.</span><span class="nx">theNameIsIrrelevant</span><span class="p">()</span> <span class="c1">// =&gt; 3</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code in javascript works because javascript functions are variables that can be assigned and passed
around like a company pen. (thats about as work safe a metaphor as I could come up with. sorry&#8230;) The only
large difference between functions and other javascript types is that functions can be <em>called.</em></p>

<p>Call time is the point where the javascript function is executed. If it contains a <em>&#8216;this&#8217;</em> inside it. That keyword then
resolves to whatever object that function is being called upon. If there is no object, <em>&#8216;this&#8217;</em> resolves
to the global object. In Browsers, the global object is <em>window.</em></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nb">window</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;ramalamadingdong&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">getFoo</span><span class="p">();</span> <span class="c1">// =&gt;  &quot;ramalamadingdong&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>on <strong>proto</strong> and prototype</h3>

<p><em>new</em> is a feature of javascript that changes the context of <em>&#8216;this&#8217;</em> in
a constructor function. when new is called on a constructor function being called, <em>new</em>
becomes an object that is being modified and eventually returned. It will delegate function calls it
cannot respond to to whatever the function&#8217;s prototype attribute is. IE: functions in javasript are
objects.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">dundar</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gummy</span><span class="o">:</span><span class="s1">&#39;bear&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ContructorFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// at this point this == {};</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// &quot;return this&quot; is implicit</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">ContructorFunction</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">dundar</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">newObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ContructorFunction</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">newObject</span><span class="p">.</span><span class="nx">gummy</span><span class="p">;</span> <span class="c1">// =&gt; &#39;bear&#39;</span>
</span><span class='line'>  <span class="nx">newObject</span><span class="p">.</span><span class="nx">foo</span><span class="p">;</span> <span class="c1">// =&gt; &#39;bar&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>The __proto__ Attribute</h3>

<p>Javascript&#8217;s prototype delegation is setup such that if an attribute is accessed on an object and the
object does not have that attribute. It will defer that request to the object set as its __proto__.
The __proto__ is determined by the constructor function&#8217;s <em>prototype</em> attribute.</p>

<h4>This begs the question? why doesn&#8217;t this work?</h4>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">var</span> <span class="nx">dundar</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gummy</span><span class="o">:</span><span class="s1">&#39;bear&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">newObject</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span> <span class="p">};</span>
</span><span class='line'>  <span class="nx">newObject</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="nx">dundar</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Actually it DOES, But only in V8 - ie: chrome and node.js</h4>

<p>(as an interesting aside, this technique is used alot in the express source code. Don&#8217;t try this at home,
unless you do server side node at home of course!)</p>

<p>Sorry to burst your bubble but I must advise you that you do not do this on the browser as it will not work
becase __proto__ is a protected attribute. Thats right, the song and dance above it using <em>new</em> is
the only surefire way to assign the __proto__ attribute.</p>

<h3>call() and apply()</h3>

<p>To recap</p>

<p>Unless you call the function with new, <em>&#8216;this&#8217;</em> becomes resolved within the function to whatever is on
the left side of the &#8216;.&#8217;.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">// if &#39;this&#39; is in the definition of getFoo, it will resolve to myObject.</span>
</span><span class='line'>  <span class="nx">myObject</span><span class="p">.</span><span class="nx">getFoo</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>call() and apply() can be called on any function and allow you to explicitly set what <em>&#8216;this&#8217;</em> will
resolve to. the only difference is that call takes the arguments of the function right after the new
meaning of <em>&#8216;this&#8217;</em> and apply takes the arguments as an array.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">myObject1</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">num</span><span class="o">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">myObject2</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;manshu&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">getFoo</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">inc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">num</span> <span class="o">+=</span> <span class="nx">num</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">num</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//errors out because it doesn&#39;t have a getFoo() method</span>
</span><span class='line'>  <span class="nx">myObject1</span><span class="p">.</span><span class="nx">getFoo</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">myObject2</span><span class="p">.</span><span class="nx">getFoo</span><span class="p">()</span> <span class="c1">// =&gt; &#39;manshu&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//heres where is gets interesting</span>
</span><span class='line'>  <span class="nx">myObject2</span><span class="p">.</span><span class="nx">getsFoo</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">myObject1</span><span class="p">)</span> <span class="c1">// =&gt; &#39;bar&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//this one errors because myObject2 does not have a num attribute</span>
</span><span class='line'>  <span class="nx">myObject2</span><span class="p">.</span><span class="nx">inc</span><span class="p">()</span> <span class="c1">// badd</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">myObject2</span><span class="p">.</span><span class="nx">inc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">myObject1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//sets myObject1.num to 2</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//apply does the same with the arguments in an array</span>
</span><span class='line'>  <span class="nx">myObject2</span><span class="p">.</span><span class="nx">inc</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">myObject1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// myObject1.num is now 3!!</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&#8217;re ready for how to create inheritence chains in javascript!
(that article is comming soon.)</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-03-31T23:34:00-07:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/javascript-/'>Javascript,</a>, <a class='category' href='/blog/categories/prototypes/'>prototypes</a>


</div>
	
		<span class="comments"><a href="/blog/2013/03/31/on-this-protototypes-and-dunderheads//index.html#disqus_thread">Comments</a></span>
	
</div></article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Peter de Croos

<div>
<a href="https://angel.co/peter-de-croos?follow=1&type=User&id=277748"></a><script src="https://angel.co/javascripts/embed.js" type="text/javascript"></script>
</div>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'peterdecroosblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-33062340-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>





</body>
</html>
